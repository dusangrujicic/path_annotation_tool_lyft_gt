<html>

<head>
  <title>Annotate objects in images</title>
  <!-- easyturk depends on these libraries -->
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js'></script>

  <!-- end of required libraries -->
  <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js'></script>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
  <script src='https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js'></script>
  <script src=https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.3.0/math.min.js></script>
  <script src="https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.15.1/dist/numjs.min.js"></script>

  <style>
    .obj-btn {
      margin-top: 20px;
      margin-top: 20px;
      font-size: 15pt;
    }

    .obj-name {
      font-size: 20pt;
      width: 500px;
      margin-top: 20px;
      margin-top: 20px;
      margin-bottom: 10px;
      height: 50px;
    }

    #button-div {
      margin-bottom: 10px;
    }

    #counter {
      margin: 0 10px;
      font-size: 20pt;
      font-weight: bold;
    }

    .desc {
      font-size: 12pt;
    }
  </style>

</head>

<style type='text/css'>
  .my-legend .legend-title {
    text-align: left;
    margin-bottom: 5px;
    font-weight: bold;
    font-size: 90%;
  }

  .my-legend .legend-scale ul {
    margin: 0;
    margin-bottom: 5px;
    padding: 0;
    float: left;
    list-style: none;
  }

  .my-legend .legend-scale ul li {
    font-size: 80%;
    list-style: none;
    margin-left: 0;
    line-height: 18px;
    margin-bottom: 2px;
  }

  .my-legend ul.legend-labels li span {
    display: block;
    float: left;
    height: 16px;
    width: 30px;
    margin-right: 5px;
    margin-left: 0;
    border: 1px solid #999;
  }

  .my-legend .legend-source {
    font-size: 70%;
    color: #999;
    clear: both;
  }

  .my-legend a {
    color: #777;
  }

  p {
    margin-bottom: 0em;
    margin-top: 0em;
  }
</style>

<body>
  <div class='container'>
    <h4><b>Specify a command that describes the path that the car took.</b></h4>

    <div class='row'>
      <div class='col-xs-7 text-center'>
        <div id='image-container'>
          <img style='width:100%; height:auto; position:absolute; z-index:1;' id='frontal-view'>
          <canvas class="video" id="frontal-view-canvas" style="position:relative; z-index:20;">
          </canvas>
        </div>
        <div class="col-xs-2">
          <button class='play-button'>Play</button>
        </div>
        <div class="col-xs-10">
          <input type='range' min='1' max='100' value='50' className='slider' id='video-slider'>
        </div>
      </div>

      <div class='col-xs-5 text-center'>
        <div id='top-down-container'>
          <img style='width:90%; height:auto; position:absolute;z-index:1;' id='top-down-view-hidden'>
          <canvas class="video" id="top-down-view" style="position:relative; z-index:20;">
          </canvas>
        </div>
      </div>
    </div>

    <div class='col-xs-8'>
      <div class='legend-title'><b>Command:</b></div>
      <div><input type="text" id="commandBox" name="commandBox" placeholder="Type command..." style='width:100%;'
          cols="40" />
      </div>
      <div id=' instructions'
        style="font-size:10; font-style:normal; background-color: #ebb5c5; border: 1px solid #f12b2b; width:100%;">
        <br />
        <p style="color: #2e6c80; font-size:12;"><b>
            You are driving around in a self-driving car. At a certain point, give a command that refers to a specific
            object to the car. We want you to do the following (<b>a video with instructions can also be found
              <a style="font-size:12px;" href="">here</a></b>):
          </b>
        </p>
        <!--<p style="color: #2e6c80; font-size:12;"><b>Task:</b></p>-->
        <ul>
          <li>
            Select the object of interest.
          </li>
          <li>
            Write the command related to the object of interest below <b>camera view (left)</b>. &nbsp;
          </li>
        </ul>
      </div>
    </div>

    <div class='my-legend'>
      <div class='legend-title'>Tasks:</div>
      <div class='legend-scale'>
        <ul class='legend-labels'>
          <li>
            <input type="text" id="task_object" value="Selected object" style="font-weight:bold;" readonly>
          </li>
          <li>
            <input type="text" id="task_command" value="Written command" style="font-weight:bold;" readonly>
          </li>
        </ul>
      </div>
    </div>

  </div>

  <div class='row'>
    <div class='col-xs-12 text-center' id='button-div'>
      <button id='prev-btn' tabindex="1" class='btn btn-lg btn-primary' disabled>Back</button>
      <span id='counter'>
        <span class='counter-top'></span> / <span class='counter-bottom'></span>
      </span>
      <button id='next-btn' tabindex="0" class='btn btn-lg btn-primary' disabled>Next</button>
    </div>
  </div>

  </div>
  </div>


  <!--IMPORTANT: This import contains all the functions you need to read in your input data and send back worker outputs.-->
  {% include "easyturk.html" %}

  <script>

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


    var DEFAULT_INPUT = [
      {
        "url": "../tmp/frontal_ix.jpg",
        "top-down": "../tmp/top_down_ix.png",
        "video_data": { "max_frame_ind": 99 },
        "frame_data": { "scene_token": "da4ed9e02f64c544f4f1f10c6738216dcb0e6b0d50952e158e5589854af9f100", "sample_token": "24b0962e44420e6322de3f25d9e4e5cc3c7a348ec00bfa69db21517e4ca92cc8", "map_patch": [-10, -40, 70, 40], "egobbox": [[2.042668386091729, -0.861845198293835], [2.04265933255577, 0.8681407829658078], [-2.0413391887133763, 0.8681334012197507], [-2.041330135177417, -0.8618525800398921]], "map_objects_center": [[22.428564572482937, -5.462834742989844], [23.83959599204012, 15.826827058996683], [19.871051193808018, 14.249354436792913], [39.18949289183157, 28.067807974087486], [35.16596622314843, -17.79090947072463], [57.68291109211376, 3.8476279945443252], [15.48151298474691, 9.651900245268184], [81.5024432517688, -12.742171378796126], [28.28029679912832, -1.1080342390404008], [23.726110845850695, 22.475073292737935], [32.75617011858311, 9.963656436266078], [38.40177739859886, -29.420146872244956], [47.9222993896387, 4.033132673466792], [24.731469414294345, -22.49102160164418], [28.79793558263129, 15.992925286722597], [12.713530958689411, 1.0851812769082256], [38.62194124446381, -24.320201133105662], [82.31076428237468, 4.920147832162236]], "map_objects_elevation": [0.1646739761228082, 0.39151102506276214, 0.22954700852235332, -0.1641898913368416, 0.09957647612036302, 0.1146921461755418, 0.17394919790028462, -0.057514524218925445, 0.09642093744173519, 0.32550241093627375, 0.06772698452962889, -0.20272617352747302, 0.18595857237417768, 0.2326701707924531, 0.24788859748157432, 0.08308951341798432, -0.06811451659245571, -0.05027059283626878], "map_objects_bbox": [[[22.38028877396178, -2.933522445689025], [20.59261924839621, -3.7224163976015605], [22.476840371004094, -7.9921470402906625], [24.264509896569663, -7.203253088378127]], [[22.83791304178162, 13.60990210150231], [24.763622109367766, 13.576426931353511], [24.841278942298622, 18.043752016491055], [22.915569874712475, 18.077227186639853]], [[18.829390858065675, 11.590165040578128], [20.9263839145714, 11.595561425179884], [20.91271152955036, 16.9085438330077], [18.815718473044637, 16.903147448405942]], [[40.55980103999632, 37.535081107311925], [37.913834051909156, 37.54829844263013], [37.81918474366682, 18.600534840863048], [40.465151731753984, 18.58731750554485]], [[36.0620593401581, -15.20208461653926], [34.30008922541745, -15.191822318511301], [34.26987310613876, -20.379734324909997], [36.03184322087941, -20.389996622937957]], [[55.358824527204, 4.813666756088578], [55.36804935387665, 2.859688531395974], [60.006997657023526, 2.8815892330000725], [59.997772830350875, 4.835567457692676]], [[14.70631443788861, 7.209750277934322], [16.672663624888628, 7.383378831992573], [16.256711531605212, 12.094050212602045], [14.29036234460519, 11.920421658543795]], [[81.89324976578848, -13.264369874197802], [81.97829986217523, -12.296097969666537], [81.11163673774911, -12.21997288339445], [81.02658664136236, -13.188244787925715]], [[29.19649896225872, 1.3546928766334365], [27.294689844855494, 1.3277469871145766], [27.36409463599792, -3.570761354714238], [29.265903753401144, -3.543815465195378]], [[22.644638965757046, 19.839471877013867], [24.715326130331768, 19.803476509735486], [24.807582725944343, 25.110674708462003], [22.73689556136962, 25.146670075740385]], [[34.16433349388283, 15.330159805170684], [31.425404445861155, 15.349874518028539], [31.34800674328338, 4.597153067361471], [34.08693579130506, 4.577438354503616]], [[39.33915460039867, -27.073328977403953], [37.57463275676733, -27.032247797432667], [37.46440019679905, -31.76696476708596], [39.22892204043039, -31.808045947057245]], [[45.6965272152519, 5.068280236727909], [45.63812700456126, 3.1341617255215013], [50.14807156402551, 2.9979851102056747], [50.20647177471614, 4.932103621412082]], [[25.689664717967393, -20.12341774752945], [23.93465875470808, -20.06434094223106], [23.773274110621298, -24.85862545575891], [25.52828007388061, -24.917702261057304]], [[29.719878438884855, 17.902902935754916], [28.023094826357337, 17.967163127616345], [27.875992726377724, 14.082947637690278], [29.572776338905243, 14.01868744582885]], [[11.327852768392258, 2.7456104994090853], [10.55087852180153, 1.0931617043976418], [14.099209148986564, -0.575247945592634], [14.876183395577291, 1.0772008494188094]], [[39.71448066719981, -21.72603732567798], [37.74411621723186, -21.645738295157596], [37.52940182172782, -26.914364940533346], [39.49976627169576, -26.99466397105373]], [[78.36664957526888, 6.9058490123985266], [77.93214964886842, 4.348497684567721], [86.25487898948047, 2.9344466519259456], [86.68937891588094, 5.491797979756751]]], "image_objects_bbox": [[[1179.8260626816077, 552.5869082095538], [1119.4509823923047, 554.3185203994539], [1120.568944827617, 647.1456379980136], [1181.194477516102, 654.1567471656012], [1387.1459964148069, 552.1572107045855], [1315.3447039619582, 553.7812633083452], [1316.7662064588644, 639.0084485791447], [1388.846769997352, 644.6977600483825]], [[318.8349354970543, 556.0887021517804], [259.02480302609246, 554.9677787272591], [258.3148897886621, 640.3352815462756], [318.2944830545987, 634.4087326683431], [110.58120365507085, 557.8828684956028], [32.453294329059155, 556.9278799886079], [31.29152476766111, 641.8747152334616], [109.65905530807913, 635.8486767973399]], [[303.77304285293917, 568.650942524005], [224.40905249826642, 568.6391306918603], [223.51787062018195, 666.2271354445579], [303.1413449016607, 655.7241532045769], [2.5771352643424614, 571.1334918675425], [-112.93471049111709, 571.4204297405281], [-114.60257441805894, 668.8961768183618], [1.3264390558014088, 658.1173226598223]], [[-171.1136483835614, 527.1403322138202], [-94.32046719835127, 529.9336066565518], [-95.97385228678111, 629.0179032040378], [-173.07969757475456, 633.3786892551037], [398.27036674573884, 522.1531256660181], [436.99141720810564, 525.2992535528184], [436.58215909301936, 624.9280096594385], [397.7333660185591, 629.0176513710547]], [[1479.7581649272208, 568.3342118724328], [1453.7857018180657, 568.3515031190493], [1454.716398184152, 615.0077123357612], [1480.7692838260448, 617.507564651619], [1657.1576469366616, 566.8831011291414], [1622.0487659542769, 566.974763031863], [1623.1672478334374, 613.7166534518963], [1658.3775091155728, 616.1516391837698]], [[905.7492516812806, 563.2835279097013], [865.5304502500434, 563.6146201996247], [865.758370864367, 601.3883329579512], [906.0131298749528, 601.0594557803147], [910.0586415434723, 563.7182645426715], [873.0270649885292, 564.0230899640218], [873.2430749004667, 598.8009696762981], [910.3051336218529, 598.4980219178492]], [[424.6717941311072, 573.4410554566083], [358.92942972425016, 574.0216746531761], [358.1887318087801, 698.522198326104], [424.1955931017479, 681.8032370769495], [58.31063015782973, 576.4604563742498], [-65.42358757359142, 577.5201822371696], [-67.47357776215478, 705.7689429803105], [56.85863696519603, 687.6510924712908]], [[1134.5678743199496, 566.2734529504554], [1148.1373266780647, 566.1606711856704], [1148.4528205424401, 590.9661674434243], [1134.8750559835423, 591.0508001373705], [1135.348785645352, 566.255479653155], [1149.0670895300714, 566.1414475061316], [1149.3865769152758, 591.2175569112164], [1135.6597774613906, 591.3028228138833]], [[906.7279835469166, 555.026607945238], [909.6732618482743, 555.9756979919533], [910.210761006162, 631.9000063114172], [907.2994870464357, 636.5549356317867], [1117.0735446729652, 553.3175133293706], [1105.597268884499, 554.3824729094866], [1106.4855409805575, 630.2016674346501], [1118.0494142091495, 634.7246501921793]], [[22.74811335055057, 561.6535860369229], [-70.83808421314328, 560.9809660158352], [-72.22429637834752, 646.9804822735063], [21.658537404970325, 640.0149281386208], [-222.94136815838422, 563.7539641552327], [-339.7343033331291, 563.2884755036008], [-341.65612089903243, 648.7813000619939], [-224.47804774113595, 641.6944030781906]], [[397.34355974632075, 487.39885902354024], [445.40492635071854, 494.17925685739726], [444.8853882877871, 627.002673261112], [396.61147755414396, 632.332201908765], [793.0263860299808, 483.72062589085397], [808.1401497154966, 490.8400048209791], [808.7650991325766, 624.2557915339465], [793.6565352718659, 629.3595664697574]], [[1800.1315789865357, 572.419519447536], [1762.2257115801397, 572.2364691823128], [1763.448441268409, 617.1214335732931], [1801.4567104445541, 619.5137979494264], [1950.385602727366, 571.2257817962789], [1905.269758833248, 571.0981898301094], [1906.6495301512327, 616.1511565260223], [1951.8840034672573, 618.5050425112863]], [[885.7491127365006, 566.0044450569126], [837.3635605223475, 566.4077186249564], [837.5803005033837, 606.7904653075357], [886.0124977002041, 606.4518630374938], [896.2289325331789, 566.2310198728819], [852.3043590882297, 566.5966552603116], [852.513981558226, 603.2404248812278], [896.4769917723081, 602.9280316407278]], [[1961.7343543164654, 556.152567106685], [1891.7895536912058, 557.047154120037], [1893.9112510864086, 627.0314405525498], [1964.1482143204692, 631.6508411015263], [2210.988097234919, 554.0648874490147], [2122.1524214711567, 555.1201934742223], [2124.67582739919, 625.667596787522], [2213.8721949687224, 630.218924821547]], [[215.6984596700983, 571.5050087168216], [263.091865445061, 571.317930130253], [262.6107289103879, 629.8749116914465], [215.11681406533933, 633.7964169042114], [373.62308368088037, 570.1844113656457], [411.79495828451616, 570.0757269843217], [411.5180917695124, 628.9902374744139], [373.2718383997273, 632.8805626601255]], [[827.3583499674547, 574.3413474279953], [652.141617110557, 575.4233919968702], [652.3134623988199, 749.8101667162666], [828.3310182541733, 763.9636809870104], [1013.1220557913717, 571.555065170632], [873.2915075447362, 572.5150928935294], [874.088005057637, 700.6489446674524], [1014.4189168457793, 707.7280675870003]], [[1629.5068768204203, 561.0745107426271], [1597.4836387271278, 561.4511347475748], [1598.7095007807607, 613.9486537569716], [1630.841659431609, 616.4397306321565], [1797.1594742778252, 559.6807657555623], [1756.1936619048936, 560.1324595310977], [1757.6260301701627, 612.9747057836581], [1798.7246772651347, 615.4295409749635]], [[901.6131825974744, 545.8614377181985], [865.1166990624739, 546.2986814195847], [865.4056035384166, 594.2375169441087], [901.9454449529487, 594.0828759054532], [926.358503925116, 547.9504776668499], [893.2895037656898, 548.3340336309099], [893.5790548098009, 591.5960809510976], [926.6836341695334, 591.4425450389192]]], "objects_token": ["3d7bdcb0c99a5ba50cc74b9b9194fe4f2fdfa82a078c8afa561eec9afad052f9", "64e6ea3476f64420c76db21b2fa4ec589def2c05ad97d2574ea63f8f0f7f22c9", "5eeaa3e4ba898b43996288c6895e8cc38ab3ba6cf7f2ae68112d8b0b936f81e5", "d924771fb6bc5ab4adb00053e9f0ea3396df9caebd24b3c25ec9223a90ebe4a2", "9995d5d003ff3f91ef6fe14e247c89f93723e57be13ef2a18956bfc5b5bd0c33", "2f7862fa773a788ca4da43bd49a8575f2dd6be4759ee547842f3ac112f6cc679", "829e30ca8c0b314e4685c4fec7a678c38d50347e2531fe8c4efc861c62ab8ba7", "f27c1315149064d2ec9d79c91e46d556bf832c6b13178e387e8dd365289d11f2", "9805befc0348d1f922c4a859d1751573e1a9689d6b34aa50c2416e6386eeee84", "69f7f6e66d7144c8a32909b3e1fee65f39a0ef970b8619c3263b129a04a9c9f1", "753a4e8f7972ff8283e1dff505946c58db4dda21fb152d95414eefca42912a5b", "6fe8822f10c4d30280f1e22288ae79f86d243fa80e8cf3c9e81f1632f35c3263", "95bda0459628fca66504e5aeed40fe5d7621a60120cf93e64407c85431752dc1", "a778a9896fb657b925c6a2835cda117b46bc27085c52e84401ab766ecfe34ee6", "ec1a9f084da1caab886c79b5d56c0955333b80c81f73d41f4756f8849da5a73e", "c1b8eaeefb86f38a8bca25896000719e517ef859985bb9d0cbf1955d4b26ffb1", "a4111990f3a4f8507517a1005c3661aa4fbe2b9dca5678334f1a271617e9465b", "844858e20360441a0f527d056ec16e5b4ba5d040b23dd2e3e4e5392f571e4f11"], "objects_type": ["car", "car", "car", "bus", "car", "car", "car", "pedestrian", "car", "car", "truck", "car", "car", "car", "car", "car", "car", "truck"], "cam_intrinsic": [[1109.05239567, 0.0, 957.849065461], [0.0, 1109.05239567, 539.672710373], [0.0, 0.0, 1.0]], "ego_translation": [0.0, 0.0, 0.0], "ego_rotation": [[1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0]], "cam_translation": [1.5039405282244198, -0.02676183592864872, 1.6584901808053665], "cam_rotation": [[0.006759426271296165, 0.02533582536529963, 0.9996561439362748], [-0.9999683364602721, 0.004369557390585865, 0.006650792816400852], [-0.004199551566444137, -0.999669446827935, 0.02536455884440647]], "subsequent_egocenters": [[2.1834352356255252e-13, 6.344205232220426e-14], [6.344205232220426e-14, -2.1834352356255252e-13], [2.1834352356255252e-13, 6.344205232220426e-14], [-2.1834352356255252e-13, -6.344205232220426e-14], [-4.3668704712510505e-13, -1.268841046444085e-13], [2.1834352356255252e-13, 6.344205232220426e-14], [3.172102616110213e-14, -1.0917176178127626e-13], [3.732449948029008e-13, 3.4522762820696104e-13], [2.1834352356255252e-13, 6.344205232220426e-14], [3.172102616110213e-14, -1.0917176178127626e-13], [2.1834352356255252e-13, 6.344205232220426e-14], [3.172102616110213e-14, -1.0917176178127626e-13], [2.1834352356255252e-13, 6.344205232220426e-14], [2.1834352356255252e-13, 6.344205232220426e-14], [6.344205232220426e-14, -2.1834352356255252e-13], [2.1834352356255252e-13, 6.344205232220426e-14], [2.1834352356255252e-13, 6.344205232220426e-14], [2.1834352356255252e-13, 6.344205232220426e-14], [2.1834352356255252e-13, 6.344205232220426e-14], [2.1834352356255252e-13, 6.344205232220426e-14], [2.1834352356255252e-13, 6.344205232220426e-14], [2.1834352356255252e-13, 6.344205232220426e-14], [2.1834352356255252e-13, 6.344205232220426e-14], [-1.2318044507924614e-13, -3.9095733766603304e-13], [2.1834352356255252e-13, 6.344205232220426e-14], [2.1834352356255252e-13, 6.344205232220426e-14], [2.1834352356255252e-13, 6.344205232220426e-14], [2.1834352356255252e-13, 6.344205232220426e-14], [2.1834352356255252e-13, 6.344205232220426e-14], [2.1834352356255252e-13, 6.344205232220426e-14], [3.172102616110213e-14, -1.0917176178127626e-13], [3.172102616110213e-14, -1.0917176178127626e-13], [2.1834352356255252e-13, 6.344205232220426e-14], [2.1834352356255252e-13, 6.344205232220426e-14], [3.172102616110213e-14, -1.0917176178127626e-13], [2.817855758847568e-13, -1.5490147124034827e-13], [2.1834352356255252e-13, 6.344205232220426e-14], [2.1834352356255252e-13, 6.344205232220426e-14], [2.1834352356255252e-13, 6.344205232220426e-14], [-2.1834352356255252e-13, -6.344205232220426e-14], [2.1834352356255252e-13, 6.344205232220426e-14], [-1.866224974014504e-13, -1.7261381410348052e-13], [-1.866224974014504e-13, -1.7261381410348052e-13], [-6.344205232220426e-14, 2.1834352356255252e-13], [0.0, 0.0], [3.172102616110213e-14, -1.0917176178127626e-13], [2.1834352356255252e-13, 6.344205232220426e-14], [-1.5490147124034827e-13, -2.817855758847568e-13], [2.1834352356255252e-13, 6.344205232220426e-14], [3.172102616110213e-14, -1.0917176178127626e-13], [-1.866224974014504e-13, -1.7261381410348052e-13], [0.04221747097198307, 0.016535765774035444], [0.08797573143101442, 0.01602851821247548], [0.19509479502645102, 0.02485709228711323], [0.4172690909355774, 0.05097086614895732], [0.713515882685927, 0.06024936876276485], [1.0814013309387687, 0.04990698657161968], [1.5314054308130842, 0.03589054256410651], [2.0890380577222474, 0.00286397791063564], [2.7723580767084446, -0.04295686840090229], [3.586502995555497, -0.061604438786779236], [4.468847659856231, -0.05660668047939721], [5.401653445136193, -0.0475581817179862], [6.399276354403949, -0.04971328478773729], [7.510617313154326, -0.04626764451195209], [8.676207270206087, -0.044610556374182764], [9.873941936846606, -0.010741285886103569], [11.094961529209272, 0.04303844167845261], [12.346367384549334, 0.09106831050232911], [13.649446674993289, 0.15069716070911277], [14.96097046531246, 0.2674098077139426], [16.2856437524357, 0.40083254715073435], [17.61095459064427, 0.5414593871052924], [18.91725334303613, 0.6952464225423096], [20.16384173692941, 0.8984842774839352], [21.44556346545529, 1.1424039777272998], [22.673574167834424, 1.4279547433716022], [23.865536866178328, 1.7410855316930167], [24.962933241714627, 2.098126897029985], [25.977052509933724, 2.469867808105205], [26.935165183355725, 2.9278414346630193], [27.84258831790859, 3.4303361466652422], [28.704629472374695, 3.9752868044539635], [29.50677032155967, 4.527153913820165], [30.25677112716807, 5.089801129669903], [30.904877455572468, 5.697604058805467], [31.484803586193454, 6.37555605277743], [32.06250127215558, 7.108194711390844], [32.60444333196509, 7.87530586751026], [33.1107487553391, 8.647302811408204], [33.56296666479148, 9.453459354968464], [33.95495141447749, 10.284959873559819], [34.307194447333366, 11.147525652731595], [34.63259159551314, 12.082409333272789], [34.92023623538085, 13.108693330210489], [35.18575958701798, 14.244818182695195], [35.43535723096779, 15.454064471066655], [35.63078059754835, 16.723027343734298], [35.76901504222084, 18.05576571279817], [35.89277340713992, 19.450966139294966], [35.974149837425834, 20.97231092687347], [36.02591770968075, 22.525699690266872], [36.050237658034376, 24.13638063584139], [36.04932541279362, 25.778240795861898], [36.04510843851377, 27.529800728939097], [36.045874054824864, 29.33312779111578], [36.05202143187415, 31.181512400225095], [36.07354229812654, 33.11264701978982], [36.10454089620361, 35.0813510197424], [36.12343651659934, 37.104379945116506], [36.13709784002514, 39.20597533963617], [36.150762196743585, 41.3470807799236], [36.124083641581485, 43.47184946195322], [36.150976330655574, 45.582678500823306], [36.16596971094829, 47.685469916901404], [36.2110893172528, 49.78649783954635], [36.27603343164559, 51.936504600928394], [36.32957016811274, 54.062411168996206], [36.40991208166503, 56.13109698908174], [36.49484930810234, 58.113385721982446], [36.59861830428058, 60.08158921621495], [36.70399760344806, 61.985089794225665], [36.82493861225312, 63.82152373876793], [36.951221440033315, 65.60867257059982]] }
      },
      // {
      //   "url": "../tmp/frontal_1.jpg",
      //   'top-down': "../tmp/top_down_1.png",
      //   "frame_data": { "scene_token": "da4ed9e02f64c544f4f1f10c6738216dcb0e6b0d50952e158e5589854af9f100", "sample_token": "c2ba18e4414ce9038ad52efab44e1a0a211ff1e6b297a632805000510756174d", "map_patch": [-10, -40, 70, 40], "egobbox": [[2.0426683860917296, -0.861845198293835], [2.0426593325557705, 0.8681407829658078], [-2.041339188713376, 0.8681334012197507], [-2.0413301351774167, -0.8618525800398921]], "map_objects_center": [[28.785855667252676, 18.134077266761793], [21.86623348736813, -4.540647067663244], [23.83959599204012, 15.826827058996683], [38.621941244463876, -24.320201133105876], [19.871051193808082, 14.249354436792693], [15.481512984746974, 9.651900245267967], [23.72611084585076, 22.47507329273772], [83.82725012608128, -7.19137554267617], [11.516763561022072, 1.533933760353644], [28.306198730871696, 1.1040304263449094], [47.922299389638766, 4.033132673466573], [38.40177739859886, -29.420146872244956], [32.78454316044355, 12.57128507360255], [81.89245148848028, -4.007108467293101], [91.05498320789559, -7.246360412038257], [81.7733042545578, -12.755524922893848], [39.189492891831414, 28.06780797408721], [35.22326793316637, -15.385051000060889], [24.75084920854963, -21.260093546895636], [80.4279116579914, 5.224837494564017]], "map_objects_elevation": [0.25819752660411865, 0.157992495008751, 0.39151102506274793, -0.06811451659245571, 0.2295470085223391, 0.17394919790028462, 0.32550241093627375, -0.28077910396127237, 0.07298978656181565, 0.27008154346449975, 0.18595857237417812, -0.20272617352747302, 0.08029122898777619, 0.14313703488881435, -0.06246646969943148, -0.057519822777601703, -0.1641898913368416, 0.11117531934844882, 0.22860229572641122, -0.05721353732904655], "map_objects_bbox": [[[29.69276931346203, 20.051236855403086], [27.995533340559437, 20.102168695006473], [27.878942021043322, 16.2169176781205], [29.576177993945915, 16.165985838517113]], [[21.64163937940848, -2.020863597467876], [19.913354987202723, -2.93253736568651], [22.09082759532778, -7.060430537858611], [23.81911198753354, -6.148756769639977]], [[22.83791304178162, 13.60990210150231], [24.763622109367766, 13.576426931353511], [24.841278942298622, 18.043752016491055], [22.915569874712475, 18.077227186639853]], [[39.71448066719987, -21.726037325678192], [37.74411621723193, -21.64573829515781], [37.52940182172788, -26.91436494053356], [39.499766271695826, -26.994663971053942]], [[18.829390858065736, 11.59016504057791], [20.926383914571463, 11.595561425179664], [20.91271152955043, 16.908543833007478], [18.8157184730447, 16.903147448405722]], [[14.706314437888674, 7.209750277934106], [16.672663624888692, 7.383378831992356], [16.256711531605276, 12.094050212601829], [14.290362344605255, 11.920421658543578]], [[22.64463896575711, 19.83947187701365], [24.71532613033183, 19.80347650973527], [24.807582725944407, 25.110674708461787], [22.736895561369685, 25.146670075740168]], [[86.15195449198096, -8.289682699698744], [86.25052951282656, -6.332163104582187], [81.5025457601816, -6.093068385653595], [81.403970739336, -8.050587980770153]], [[10.046084243392757, 3.119566629178383], [9.356657300832996, 1.4287187676388824], [12.987442878651388, -0.051699108471095157], [13.676869821211149, 1.6391487530684057]], [[29.233137812507458, 3.5627364252264866], [27.331229225706405, 3.5440889735928542], [27.379259649235934, -1.3546755725366677], [29.281168236036986, -1.3360281209030354]], [[45.69652721525196, 5.068280236727691], [45.638127004561326, 3.134161725521285], [50.14807156402557, 2.997985110205455], [50.206471774716206, 4.932103621411862]], [[39.33915460039867, -27.073328977403953], [37.57463275676733, -27.032247797432667], [37.46440019679905, -31.76696476708596], [39.22892204043039, -31.808045947057245]], [[34.19270653574327, 17.937788442507156], [31.453777487721595, 17.95750315536501], [31.376379785143822, 7.204781704697942], [34.1153088331655, 7.185066991840087]], [[84.14234774016523, -4.948120213582153], [84.17767471999655, -3.1554682661880147], [79.64255523679532, -3.0660967210040484], [79.607228256964, -4.858748668398187]], [[93.22432255801243, -8.162798098973179], [93.27101567788134, -6.4494342285250745], [88.88564385777875, -6.3299227251033345], [88.83895073790984, -8.04328659555144]], [[82.1641107685775, -13.277723418295524], [82.24916086496424, -12.309451513764259], [81.3824977405381, -12.233326427492171], [81.29744764415136, -13.201598332023437]], [[40.55980103999617, 37.53508110731165], [37.913834051909, 37.54829844262984], [37.81918474366666, 18.60053484086277], [40.46515173175383, 18.587317505544572]], [[36.09220230183407, -12.786984399115475], [34.330221332463275, -12.795173634436669], [34.35433356449867, -17.983117601006303], [36.11631453386946, -17.97492836568511]], [[25.70904451222268, -18.892489692780906], [23.954038548963368, -18.833412887482513], [23.792653904876584, -23.627697401010366], [25.547659868135895, -23.68677420630876]], [[76.45645668939599, 7.155276675791653], [76.05770531673603, 4.592108061985336], [84.39936662658681, 3.2943983133363823], [84.79811799924677, 5.857566927142699]]], "image_objects_bbox": [[[126.36410912006515, 571.8081726184639], [178.62309593845745, 571.6070869387423], [178.02469774712543, 630.1908872048933], [125.65048566717665, 634.1311885105393], [284.6138045676911, 570.4865011287649], [327.60769527778166, 570.3639821531506], [327.213759987699, 629.2417505847284], [284.13087531601207, 633.1423156320525]], [[1140.0580804832055, 552.7901368053787], [1074.768964166548, 554.5759495852844], [1075.825989973033, 650.7903686480689], [1141.3776780140709, 658.0921372053557], [1344.6461219528665, 552.6252372081539], [1269.7348255570753, 554.2515425842815], [1271.0905741236882, 641.160942132097], [1346.2836319777684, 646.8823530285532]], [[318.8349354971204, 556.088702151794], [259.0248030261668, 554.967778727274], [258.3148897887365, 640.3352815462874], [318.2944830546649, 634.4087326683542], [110.58120365514303, 557.8828684956163], [32.45329432914081, 556.9278799886226], [31.291524767743137, 641.8747152334736], [109.65905530815192, 635.8486767973509]], [[1629.5068768204414, 561.0745107426352], [1597.483638727148, 561.4511347475825], [1598.7095007807811, 613.9486537569782], [1630.8416594316298, 616.4397306321633], [1797.1594742778425, 559.6807657555706], [1756.1936619049109, 560.1324595311054], [1757.6260301701795, 612.9747057836647], [1798.7246772651522, 615.4295409749706]], [[303.77304285303353, 568.6509425240207], [224.4090524983757, 568.639130691878], [223.51787062029155, 666.2271354445712], [303.1413449017552, 655.7241532045891], [2.5771352644491645, 571.1334918675582], [-112.93471049099199, 571.4204297405456], [-114.6025744179337, 668.896176818375], [1.32643905590857, 658.1173226598344]], [[424.6717941312216, 573.4410554566275], [358.9294297243856, 574.0216746531978], [358.18873180891586, 698.5221983261184], [424.1955931018625, 681.8032370769629], [58.3106301579668, 576.4604563742691], [-65.42358757342569, 577.5201822371919], [-67.47357776198857, 705.7689429803248], [56.85863696533342, 687.6510924713042]], [[22.748113350638626, 561.6535860369356], [-70.83808421304296, 560.9809660158492], [-72.22429637824729, 646.9804822735169], [21.65853740505858, 640.0149281386308], [-222.94136815828827, 563.7539641552453], [-339.7343033330195, 563.2884755036147], [-341.65612089892255, 648.7813000620046], [-224.47804774103977, 641.6944030782006]], [[1047.880182171187, 570.4242735460277], [1073.662641195991, 570.2154085759963], [1073.9156235960209, 593.3063500996831], [1048.1187683995863, 593.4849425993261], [1049.4613320872622, 570.5523968534934], [1076.7786619159674, 570.3312944548748], [1077.0484949457643, 594.7957620410141], [1049.7150034208148, 594.9828860874916]], [[759.0945243011919, 577.0078668623055], [556.8973221180536, 578.1316235877547], [556.6431728627086, 778.7137847426918], [759.8626412547987, 795.5474171545744], [967.160456577436, 573.220188211095], [813.0934180783312, 574.2277339413766], [813.7679498393079, 714.985801191535], [968.420579832387, 722.5913833629855]], [[811.725808220441, 548.3865107356378], [821.5043686253662, 549.7858322518604], [821.8827139583738, 625.5465610138461], [812.1132057943211, 629.7263984655547], [1021.8140764590954, 546.6723598666399], [1017.2045029830223, 548.1882289039132], [1017.9332921070691, 623.9025795798626], [1022.6053954833678, 627.958789875776]], [[885.7491127365313, 566.0044450569192], [837.3635605223789, 566.407718624963], [837.5803005034153, 606.7904653075416], [886.012497700235, 606.4518630374997], [896.2289325332066, 566.2310198728878], [852.3043590882583, 566.5966552603176], [852.5139815582546, 603.2404248812331], [896.476991772336, 602.9280316407331]], [[1800.1315789865475, 572.4195194475438], [1762.2257115801517, 572.2364691823205], [1763.4484412684214, 617.1214335732999], [1801.456710444566, 619.5137979494334], [1950.3856027273748, 571.2257817962869], [1905.2697588332574, 571.0981898301171], [1906.6495301512418, 616.151156526029], [1951.8840034672662, 618.5050425112935]], [[302.18711016420986, 487.84916264730305], [358.1102943452115, 494.58259386709284], [357.31711741012003, 627.2216610039994], [301.12979160502556, 632.5630361644068], [696.7963847192173, 484.17876761781685], [719.9434538320573, 491.2498372910734], [720.2890693313077, 624.4796280262836], [697.0939004696589, 629.596098498481]], [[1007.2809000302317, 570.1736472468177], [1031.381656074516, 569.9765009353235], [1031.5667318146345, 588.5660804585685], [1007.455279067321, 588.7527210717788], [1008.4451514558242, 570.2681459604784], [1033.946459504266, 570.0596057327843], [1034.143483342567, 589.7294692853224], [1008.6301989474916, 589.9262476984346]], [[1042.9505546971411, 567.10882571787], [1063.7355773930756, 566.9373029014928], [1063.9697251173454, 588.7754918360909], [1043.17382403783, 588.9333067161252], [1045.3275869539457, 567.040151811583], [1067.1582686724746, 566.8599674214859], [1067.4060415590948, 589.7956943321867], [1045.563359090946, 589.9607587769199]], [[1134.1835540966306, 566.2802463959207], [1147.70697123562, 566.1678513327684], [1148.0211526039996, 590.8899457143876], [1134.4894795609898, 590.9743805694272], [1134.957644363037, 566.2624078186059], [1148.628899330903, 566.1487709772114], [1148.947041744103, 591.1396519769081], [1135.2673493735826, 591.2247176711543]], [[-171.11364838350545, 527.1403322138289], [-94.32046719830063, 529.9336066565596], [-95.97385228672975, 629.0179032040443], [-173.07969757469843, 633.3786892551107], [398.2703667457859, 522.1531256660269], [436.99141720814873, 525.2992535528264], [436.5821590930627, 624.928009659445], [397.7333660186062, 629.0176513710618]], [[1397.8193391268485, 568.6093619504771], [1375.4709248653926, 568.6174584466931], [1376.3140577746472, 615.2113203227988], [1398.733857582364, 617.7136553725925], [1573.796826927494, 567.1634290511364], [1542.4525491067316, 567.2453904741753], [1543.4800139101415, 613.8511050364513], [1574.9160855820267, 616.2808870659189]], [[1899.360144338369, 556.8729832797429], [1834.038741909963, 557.7140720363799], [1836.0625075338778, 627.6198909043864], [1901.6597565215634, 632.279945803999], [2147.7628437547924, 554.7941560255391], [2063.671990498865, 555.794698074134], [2066.094996105695, 626.2623667907142], [2150.529583438995, 630.8552898875438]], [[896.3925452860931, 545.4206157530618], [858.8803368566869, 545.8612488228868], [859.1693425694073, 595.0203295894491], [896.7270488484896, 594.8532327031045], [920.6743583554446, 547.6188245688879], [886.7903367936124, 548.0044621164923], [887.079650129122, 592.2473730835842], [921.0007782434815, 592.0831739830356]]], "objects_token": ["9f1434fa2688e89f7770958b13a24cb6b1d815a31ab1efb6346565799482d350", "47e4e36bb20cb953b0cc29815e0384b60b4ab08c8326db1efa157246caa985fb", "a43b9692c479c7d858042f3c887a8495a9557c830387c98194780101c17ca581", "f5d289567e9ef2935b5446ee59f2328c2811b35340d9476f593c18a9eb10bb0e", "3d70e618abd560d2709a1efb050dbde69fd8272a8d4a230263326aab04e33ea0", "f4fc5b332bff7547cd14028e17d5f65e4de947bd82be582a0d804b9d4c913270", "fae22739ac1ea164bbb331f14003540f204e282630465962c09ff52c6f79242b", "bb6a11d82ac7347b908eb19d9237fa2fc16a08904b5034e8b160a72f954f0a2b", "c8d5986cb604a0f7ced0914b01c8e55c452e30f1497566852e6c4fa0f6973778", "4623d25590174883374962538492df4f536ac4e154fa044b60d929e85dd82cdb", "65ea82e506281e7477787183dc2916a0c7774b7334b3e90349f66d81b69da0fc", "a16344b537fc37dc408b5c05aecc27cd4379f05e04fedb5baebd8b827d92884b", "1eee6bfd89289a7d73fbe7f2bdd85850eb360364cdbdc75b9fe1d0c13b177a37", "9a03e5420e230733f5d1934506cedd3767b14aa9dc490ff6502e85e61cadb3ad", "b7e7c25fe045bf16bd4627dcb4edabb51416bdc1450492683117925e9e6c1113", "9e3ed9d3239c96d68a3d6125835a36a439db31cded6d4af764545adf6643b35e", "e8deea03632438ac087553096cb3418873193e418dc31eb027a6bdfa037a0d12", "f4f6273edfd0dac35db9fa92ed757eb09bd7383ed94848de11c11984ce3b1ccb", "6330695559e34f890641693d75c011eab135220176142c61646e08fa69126639", "a4fb07d1b77dc069389a9a54936b4058b3a81dae4365002e4919f67402811de5"], "objects_type": ["car", "car", "car", "car", "car", "car", "car", "car", "car", "car", "car", "car", "truck", "car", "car", "pedestrian", "bus", "car", "car", "truck"], "cam_intrinsic": [[1109.05239567, 0.0, 957.849065461], [0.0, 1109.05239567, 539.672710373], [0.0, 0.0, 1.0]], "ego_translation": [0.0, 0.0, 0.0], "ego_rotation": [[1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0]], "cam_translation": [1.5039405282244198, -0.02676183592864872, 1.6584901808053665], "cam_rotation": [[0.006759426271296165, 0.02533582536529963, 0.9996561439362748], [-0.9999683364602721, 0.004369557390585865, 0.006650792816400852], [-0.004199551566444137, -0.999669446827935, 0.02536455884440647]], "subsequent_egocenters": [[-1.5490147124034827e-13, -2.817855758847568e-13], [0.0, 0.0], [-4.3668704712510505e-13, -1.268841046444085e-13], [-6.550305706876576e-13, -1.9032615696661277e-13], [0.0, 0.0], [-1.866224974014504e-13, -1.7261381410348052e-13], [1.5490147124034827e-13, 2.817855758847568e-13], [0.0, 0.0], [-1.866224974014504e-13, -1.7261381410348052e-13], [0.0, 0.0], [-1.866224974014504e-13, -1.7261381410348052e-13], [0.0, 0.0], [0.0, 0.0], [-1.5490147124034827e-13, -2.817855758847568e-13], [0.0, 0.0], [0.0, 0.0], [0.0, 0.0], [0.0, 0.0], [0.0, 0.0], [0.0, 0.0], [0.0, 0.0], [0.0, 0.0], [-3.415239686417987e-13, -4.543993899882373e-13], [0.0, 0.0], [0.0, 0.0], [0.0, 0.0], [0.0, 0.0], [0.0, 0.0], [0.0, 0.0], [-1.866224974014504e-13, -1.7261381410348052e-13], [-1.866224974014504e-13, -1.7261381410348052e-13], [0.0, 0.0], [0.0, 0.0], [-1.866224974014504e-13, -1.7261381410348052e-13], [6.344205232220426e-14, -2.1834352356255252e-13], [0.0, 0.0], [0.0, 0.0], [0.0, 0.0], [-4.3668704712510505e-13, -1.268841046444085e-13], [0.0, 0.0], [-4.049660209640029e-13, -2.3605586642568477e-13], [-4.049660209640029e-13, -2.3605586642568477e-13], [-2.817855758847568e-13, 1.5490147124034827e-13], [-2.1834352356255252e-13, -6.344205232220426e-14], [-1.866224974014504e-13, -1.7261381410348052e-13], [0.0, 0.0], [-3.732449948029008e-13, -3.4522762820696104e-13], [0.0, 0.0], [-1.866224974014504e-13, -1.7261381410348052e-13], [-4.049660209640029e-13, -2.3605586642568477e-13], [0.042217470971764724, 0.016535765773972002], [0.08797573143079607, 0.016028518212412038], [0.19509479502623267, 0.024857092287049787], [0.417269090935359, 0.05097086614889389], [0.7135158826857086, 0.06024936876270143], [1.0814013309385504, 0.04990698657155623], [1.5314054308128657, 0.03589054256404306], [2.0890380577220293, 0.0028639779105722463], [2.772358076708226, -0.0429568684009658], [3.5865029955552785, -0.06160443878684263], [4.468847659856014, -0.05660668047946049], [5.401653445135975, -0.04755818171804971], [6.399276354403731, -0.04971328478780079], [7.510617313154108, -0.04626764451201559], [8.676207270205868, -0.04461055637424627], [9.873941936846387, -0.010741285886167073], [11.094961529209053, 0.043038441678389106], [12.346367384549115, 0.0910683105022656], [13.64944667499307, 0.15069716070904926], [14.960970465312242, 0.26740980771387957], [16.28564375243548, 0.4008325471506713], [17.61095459064405, 0.5414593871052285], [18.917253343035913, 0.6952464225422466], [20.16384173692919, 0.8984842774838722], [21.445563465455074, 1.142403977727236], [22.673574167834207, 1.4279547433715392], [23.865536866178108, 1.7410855316929537], [24.962933241714406, 2.098126897029922], [25.977052509933507, 2.469867808105141], [26.935165183355508, 2.9278414346629553], [27.842588317908373, 3.430336146665179], [28.704629472374474, 3.9752868044539014], [29.50677032155945, 4.527153913820101], [30.25677112716785, 5.089801129669841], [30.90487745557225, 5.697604058805405], [31.484803586193234, 6.375556052777366], [32.06250127215536, 7.108194711390782], [32.60444333196487, 7.875305867510196], [33.11074875533889, 8.64730281140814], [33.56296666479126, 9.4534593549684], [33.95495141447727, 10.284959873559755], [34.30719444733315, 11.147525652731531], [34.63259159551293, 12.082409333272725], [34.92023623538063, 13.108693330210425], [35.185759587017756, 14.244818182695132], [35.43535723096757, 15.454064471066593], [35.63078059754813, 16.723027343734234], [35.76901504222063, 18.055765712798106], [35.8927734071397, 19.450966139294902], [35.97414983742562, 20.972310926873405], [36.02591770968053, 22.52569969026681], [36.05023765803416, 24.136380635841327], [36.04932541279341, 25.778240795861834], [36.04510843851355, 27.529800728939033], [36.04587405482465, 29.333127791115714], [36.05202143187393, 31.18151240022503], [36.07354229812632, 33.11264701978975], [36.104540896203396, 35.08135101974234], [36.12343651659912, 37.10437994511645], [36.13709784002492, 39.20597533963611], [36.150762196743365, 41.34708077992354], [36.124083641581265, 43.471849461953155], [36.150976330655354, 45.58267850082324], [36.16596971094807, 47.68546991690134], [36.21108931725257, 49.786497839546286], [36.27603343164536, 51.93650460092833], [36.329570168112525, 54.06241116899614], [36.409912081664814, 56.131096989081676], [36.49484930810212, 58.11338572198238], [36.59861830428035, 60.08158921621488], [36.70399760344784, 61.9850897942256], [36.8249386122529, 63.821523738767866], [36.951221440033095, 65.60867257059977]] }
      // }
    ];

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


    // If this is a HIT on AMT, then replace the default input with the real input.
    var input = easyturk.getInput(DEFAULT_INPUT);
    var num_images = input.length;

    // Some variables to track state of the HIT.
    var idx = 0;
    var enabled = false;
    var output = [];
    var bb = null;

    var play = false;

    var createdAnnotationsOutputList = [];

    function main() {

      if (true || !easyturk.isPreview()) {
        enable_hit();
      }

      // Set up empty description blobs.
      for (var k = 0; k < num_images; k++) {
        input[k].objects = [];
        for (var l = 0; l < input[k].num_objects; l++) {
          input[k].objects.push({ 'name': '', 'rect': null });
        }
        output.push(input[k]);
      }

      // Load the images.
      _.each(output, function (input_elem) {
        // var imgUrl = input_elem['url'];//.replace(`_ix`, `_${input[idx]["command_data"]['max_frame_ind']}`);
        var imgUrl = input_elem['url'].replace(`_ix`, `_0`);
        var img = new Image();
        img.onload = function () {
          output[idx].image_width = img.width;
        };
        img.src = imgUrl;

      });

      $.ajaxSetup({
        async: false
      });
      // Fetch the frame data
      _.each(input, function (input_elem) {
        console.log(input_elem["frame_data"])

        $.getJSON(input_elem["frame_data"], function (data) {
          console.log(data);
          input_elem["frame_data"] = data
        })
      })
      console.log(input)
      $.ajaxSetup({
        async: true
      });

      // Render the objects and the bounding box interaction.
      set_idx(idx, true);
    }

    function add_existing_boxes(bb) {
      /** Draws the existing bounding boxes to the image.
       *
       * Args:
       *   bb: ETJS.BBoxDrawer instance.
       */
      for (var k = 0; k < output[idx].num_objects; k++) {
        obj = output[idx].objects[k];
        if (obj.rect != null) {
          index = bb.addStaticBox(obj.rect);
          obj.static_index = index;
        }
      }
    }

    // For transform to image and map
    var egopose_translation;
    var egopose_rotmat;
    var cam_translation;
    var cam_rotmat;
    var cam_intrinsics;
    var map_patch;
    var canvasFrontal;
    var frontalViewRatioW;
    var frontalViewRatioH;
    var referredObjectIx;

    // Use the current index to update the image and description.
    function render() {
      // Set up the image
      play = false;
      // $("#frontal-view").attr('src', input[idx]['url']);//.replace(`_ix`, `_${input[idx]["command_data"]['max_frame_ind']}`));
      $("#frontal-view").attr('src', input[idx]['url'].replace(`_ix`, `_0`));
      console.log($("#frontal-view"));

      $("#video-slider").attr("max", input[idx]["video_data"]["max_frame_ind"]).attr("value", 0);

      // $("#top-down-view-hidden").attr('src', input[idx]['top-down']);//.replace(`_ix`, `_${input[idx]["command_data"]['max_frame_ind']}`));
      $("#top-down-view-hidden").attr('src', input[idx]['top-down'].replace(`_ix`, `_0`));

      // Top Down View
      var image = new Image();
      image.onload = function () {
        drawImage(image);
      }
      image.src = input[idx]['top-down'].replace(`_ix`, `_0`);

      // Frontal Image
      var imageFrontal = new Image();
      imageFrontal.onload = function () {
        canvasFrontal = document.getElementById('frontal-view-canvas');
        canvasFrontal.width = $("#frontal-view").width();
        canvasFrontal.height = $("#frontal-view").height();
        frontalViewRatioW = (canvasFrontal.width / 1920);
        frontalViewRatioH = (canvasFrontal.height / 1080);
      }
      imageFrontal.src = input[idx]['url'].replace(`_ix`, `_0`);


      egopose_translation = math.matrix([input[idx]["frame_data"]["ego_translation"]])
      egopose_rotmat = math.matrix(input[idx]["frame_data"]["ego_rotation"])
      cam_translation = math.matrix([input[idx]["frame_data"]["cam_translation"]])
      cam_rotmat = math.matrix(input[idx]["frame_data"]["cam_rotation"]);
      cam_intrinsics = math.matrix(input[idx]["frame_data"]["cam_intrinsic"]);
      map_patch = math.matrix(input[idx]["frame_data"]["map_patch"]);
      subsequent_egocenters = input[idx]["frame_data"]["subsequent_egocenters"]

      first_run = true;
      is_drawing_car_end_point = false;

      // Refresh the counter
      $('.counter-top').text(idx + 1);
      $('.counter-bottom').text(input.length);

      // If the UI is enabled, enable or disable the buttons depending on
      // the index.
      if (enabled) {
        $('#prev-btn').prop('disabled', false);
        $('#next-btn').prop('disabled', false);
        if (idx == 0) {
          $('#prev-btn').prop('disabled', true);
        }
        if (idx == input.length - 1) {
          $('#next-btn').prop('disabled', true);
        }
      }
    }

    hRatio = null;
    vRatio = null;
    function drawImageScaled(img, ctx) {
      var canvasTopDown = ctx.canvas;
      hRatio = canvasTopDown.width / img.width;
      vRatio = canvasTopDown.height / img.height;
      ratio = Math.min(hRatio, vRatio);
      var centerShift_x = (canvasTopDown.width - img.width * ratio) / 2;
      var centerShift_y = (canvasTopDown.height - img.height * ratio) / 2;
      ctx.clearRect(0, 0, canvasTopDown.width, canvasTopDown.height);
      ctx.drawImage(img, 0, 0, img.width, img.height,
        centerShift_x, centerShift_y, img.width * ratio, img.height * ratio);
    }

    function drawImage(image) {
      canvasTopDown = document.getElementById('top-down-view');

      canvasTopDown.width = $("#top-down-view-hidden").width();
      canvasTopDown.height = $("#top-down-view-hidden").height();//image.height;

      topDownCtx = canvasTopDown.getContext("2d");
      $canvasTopDown = $("#top-down-view");
      canvasTopDownOffset = $canvasTopDown.offset();
      canvasTopDownOffsetX = canvasTopDownOffset.left;
      canvasTopDownOffsetY = canvasTopDownOffset.top;
      scrollX = $canvasTopDown.scrollLeft();
      scrollY = $canvasTopDown.scrollTop();

      canvasTopDownW = canvasTopDown.width;
      canvasTopDownH = canvasTopDown.height;
      canvasTopDownCw = canvasTopDownW / 2;  // center
      canvasTopDownCh = canvasTopDownH / 2;
    }

    $(document).on('change', "#video-slider", function (e) {
      var currIx = $(this).val()
      console.log("curr", currIx)
      $("#frontal-view").attr('src', input[idx]['url'].replace(`_ix`, `_${currIx}`));
      $("#top-down-view-hidden").attr('src', input[idx]['top-down'].replace(`_ix`, `_${currIx}`));
      var image = new Image();
      image.onload = function () {
        drawImage(image);
      }
      image.src = input[idx]['top-down'].replace(`_ix`, `_${currIx}`);
    })

    $(document).on('click', ".play-button", function (e) {
      if (play) {
        $(this).text("Play");
        play = false
      } else {
        $(this).text("Stop");
        play = true
        playVideo();
      }
    })

    function playVideo() {
      var currImg = Number($("#video-slider").val());
      var maxImg = input[idx]["video_data"]['max_frame_ind'];
      function changeImgs() {
        if (currImg <= maxImg) {
          $("#video-slider").val(currImg);
          $("#video-slider").trigger("change");
          currImg += 1;
          if (play) {
            setTimeout(changeImgs, 200);
          }
        } else {
          $(".play-button").click();
        }
      }
      setTimeout(changeImgs, 200);
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


    var canvasTopDownOffsetX;
    var canvasTopDownOffsetY;

    var canvasTopDown;
    var topDownCtx;

    const Point2 = (x, y) => ({ x, y });  // creates a point
    const Line = (p1, p2) => ({ p1, p2 });
    const setStyle = (style) => eachOf(Object.keys(style), key => { topDownCtx[key] = style[key] });
    const eachOf = (array, callback) => { var i = 0; while (i < array.length && callback(array[i], i++) !== true); };

    const list = {
      items: null,
      length() { return this.items.length },
      add(item) { this.items.push(item); return item },
      eachItem(callback) {
        var i = 0;
        while (i < this.items.length) {
          callback(this.items[i], i++);
        }
      }
    }

    function __drawLine(start, end, color = "rgba(205,50,50,1)") {
      var canvasFrontal = document.getElementById('frontal-view-canvas')
      var context = canvasFrontal.getContext('2d');
      context.lineWidth = 2;
      context.strokeStyle = color;
      context.beginPath();
      context.moveTo(start[0] / 1920 * canvasFrontal.width, (start[1] / 1080) * canvasFrontal.height);
      context.lineTo(end[0] / 1920 * canvasFrontal.width, (end[1] / 1080) * canvasFrontal.height);
      context.stroke();
    }

    function __drawRect(selectedCorners, color = "rgba(205,50,50,1)") {
      var prev = selectedCorners[selectedCorners.length - 1];
      for (var i = 0; i < selectedCorners.length; i++) {
        var corner = selectedCorners[i];
        this.__drawLine([parseInt(prev[0]), parseInt(prev[1])],
          [parseInt(corner[0]), parseInt(corner[1])],
          color);
        prev = corner;
      }
    }

    function drawBox(box_points, color = "rgba(205,50,50,1)") {
      // Draw the sides;
      box_points = box_points[0].map((_, colIndex) => box_points.map(row => row[colIndex]));
      for (var i = 0; i < 4; i++) {
        __drawLine([parseInt(box_points[i][0]), parseInt(box_points[i][1])],
          [parseInt(box_points[i + 4][0]), parseInt(box_points[i + 4][1])],
          color);
      }
      __drawRect(box_points.slice(0, 4), color);
      __drawRect(box_points.slice(4, 8), color);
    }

    function drawObjectsFrontal(special_index = -1) {
      var objectsToDraw = input[idx]["frame_data"]["image_objects_bbox"];

      for (var i = 0; i < objectsToDraw.length; i++) {
        //console.log(objectsToDraw[i])
        //var is_referred = objectsToDraw[i]["is_referred"];

        if (i == referredObjectIx) {
          color = "rgba(255,226,0,1)";
        } else if (i == special_index) {
          color = "rgba(205,50,50,1)";
        } else {
          // Set opacity to 0 to make it transparent
          color = "rgba(47,79,79,0)";
        }

        var box = math.transpose(math.matrix(objectsToDraw[i]))._data; // 2 x 8 matrix , first row is x, second is y
        drawBox(box, color);
      }
    }

    function drawObjectsTopDown(special_index = -1) {
      var objectsToDraw = math.matrix(input[idx]["frame_data"]["map_objects_bbox"]);
      // console.log(objectsToDraw)
      // console.log(map_patch)
      // throw new Error();

      // Step 1: Convert points to canvas coords

      var map_patch_corner_x = map_patch.subset(math.index(0))
      var map_patch_corner_y = map_patch.subset(math.index(1))
      var map_patch_width = map_patch.subset(math.index(2)) - map_patch.subset(math.index(0))
      var map_patch_height = map_patch.subset(math.index(3)) - map_patch.subset(math.index(1))

      var canvasTopDown_width = canvasTopDown.width;
      var canvasTopDown_height = canvasTopDown.height;

      var x = objectsToDraw.subset(math.index(math.range(0, objectsToDraw.size()[0]), math.range(0, objectsToDraw.size()[1]), 0));
      var y = objectsToDraw.subset(math.index(math.range(0, objectsToDraw.size()[0]), math.range(0, objectsToDraw.size()[1]), 1));
      var converted_x = math.multiply(math.divide(math.subtract(x, map_patch_corner_x), (map_patch_width)), canvasTopDown_width);
      var converted_y = math.multiply(math.subtract(1, math.divide(math.subtract(y, map_patch_corner_y), (map_patch_height))), canvasTopDown_height);
      var convertedPoints = math.concat(converted_x, converted_y, 2);
      //console.log(convertedPoints);
      // Convert Ego bounding box coords
      var ego_box = math.matrix(input[idx]["frame_data"]["egobbox"]);

      var ego_x = ego_box.subset(math.index(math.range(0, ego_box.size()[0]), 0));
      var ego_y = ego_box.subset(math.index(math.range(0, ego_box.size()[0]), 1));
      var ego_converted_x = math.multiply(math.divide(math.subtract(ego_x, map_patch_corner_x), (map_patch_width)), canvasTopDown_width);
      var ego_converted_y = math.multiply(math.subtract(1, math.divide(math.subtract(ego_y, map_patch_corner_y), (map_patch_height))), canvasTopDown_height);
      var rel_x_points = math.subtract(ego_converted_x, math.mean(ego_converted_x));
      var rel_y_points = math.subtract(ego_converted_y, math.mean(ego_converted_y));
      var ego_convertedPoints = math.concat(ego_converted_x, ego_converted_y, 1);
      //console.log(ego_convertedPoints);
      car_box_format_relative = math.concat(rel_x_points, rel_y_points, 1);
      // Step 2: Draw points on canvas

      var context = canvasTopDown.getContext('2d');
      context.lineWidth = 3;

      if (convertedPoints.size()[1] == 4) {
        convertedPoints = math.concat(
          convertedPoints,
          convertedPoints.subset(
            math.index(
              math.range(0, convertedPoints.size()[0]),
              0,
              math.range(0, convertedPoints.size()[2]))
          ),
          1
        )
      }

      for (var i = 0; i < convertedPoints.size()[0]; i++) {

        if (i == referredObjectIx) {
          context.strokeStyle = "rgba(255,226,0,1)";
        } else if (i == special_index) {
          context.strokeStyle = "rgba(205,50,50,1)";
        } else {
          context.strokeStyle = "rgba(47,79,79,1)";
        }
        context.beginPath();
        // If not closed, close it
        for (var j = 0; j < convertedPoints.size()[1] - 1; j++) {
          context.moveTo(
            math.subset(convertedPoints, math.index(i, j, 0)),
            math.subset(convertedPoints, math.index(i, j, 1))
          );
          context.lineTo(
            math.subset(convertedPoints, math.index(i, j + 1, 0)),
            math.subset(convertedPoints, math.index(i, j + 1, 1))
          )
        }
        context.stroke();
      }

      // Draw ego box
      context.strokeStyle = "rgba(0,255,215,1)";
      context.beginPath();
      if (ego_convertedPoints.size()[0] == 4) {
        ego_convertedPoints = math.concat(
          ego_convertedPoints,
          ego_convertedPoints.subset(
            math.index(
              0,
              math.range(0, ego_convertedPoints.size()[1]))
          ),
          0
        )
      }
      for (var i = 0; i < ego_convertedPoints.size()[0] - 1; i++) {
        context.moveTo(
          math.subset(ego_convertedPoints, math.index(i, 0)),
          math.subset(ego_convertedPoints, math.index(i, 1))
        );
        context.lineTo(
          math.subset(ego_convertedPoints, math.index(i + 1, 0)),
          math.subset(ego_convertedPoints, math.index(i + 1, 1))
        )
      }

      center = [
        math.mean(math.subset(ego_convertedPoints, math.index(math.range(0, 4), 0))),
        math.mean(math.subset(ego_convertedPoints, math.index(math.range(0, 4), 1)))
      ]

      context.moveTo(
        center[0],
        center[1],
      )
      context.lineTo(
        math.subset(ego_convertedPoints, math.index(0, 0)) / 2 + math.subset(ego_convertedPoints, math.index(1, 0)) / 2,
        math.subset(ego_convertedPoints, math.index(0, 1)) / 2 + math.subset(ego_convertedPoints, math.index(1, 1)) / 2
      )
      context.stroke();
    }

    function getSidePoints(point1, point2, thickness, farside = true) {

      if (point2[0] - point1[0] == 0) {
        angle = math.PI / 2;
      } else {
        angle = math.atan2(point2[1] - point1[1], point2[0] - point1[0])
      }
      if (farside) {
        target_point = point2
      } else {
        target_point = point1
      }
      p_right = math.sin(angle) * thickness + target_point[0]
      q_right = -math.cos(angle) * thickness + target_point[1]
      p_left = -math.sin(angle) * thickness + target_point[0]
      q_left = math.cos(angle) * thickness + target_point[1]

      return [[p_left, q_left], [p_right, q_right]]
    }

    function computePolygonSides(path_points, thickness) {

      polygon_sides_left = []
      polygon_sides_right = []

      for (i = 1; i < path_points.length; i++) {
        if (i < path_points.length - 1) {
          side_points = getSidePoints(path_points[i - 1], path_points[i], thickness, false)
          polygon_sides_left.push(side_points[0])
          polygon_sides_right.push(side_points[1])
        } else {
          side_points = getSidePoints(path_points[i - 1], path_points[i], thickness, false)
          polygon_sides_left.push(side_points[0])
          polygon_sides_right.push(side_points[1])
          side_points = getSidePoints(path_points[i - 1], path_points[i], thickness, true)
          polygon_sides_left.push(side_points[0])
          polygon_sides_right.push(side_points[1])
        }
      }
      polygon_sides_right.reverse()
      return polygon_sides_left.concat(polygon_sides_right)
    }

    function most_frequent(arr) {
      var o = {}, maxCount = 0, maxValue, m;
      for (var i = 0, iLen = arr.length; i < iLen; i++) {
        m = arr[i];

        if (!o.hasOwnProperty(m)) {
          o[m] = 0;
        }
        ++o[m];

        if (o[m] > maxCount) {
          maxCount = o[m];
          maxValue = m;
        }
      }
      return maxValue;
    }

    function projectElevatedPathToFrontalView() {
      // 1) Add 0 to third dimension
      if (path_points.items.length < 2) {
        return;
      }

      // 1) Create polygons in 2D and append z-axis
      // Scale path points to map coordinates
      var points_map = math.matrix(path_points.projectPointsToMap());

      // Convert path points to polygon side points
      points_map = math.matrix(computePolygonSides(points_map._data, 1))
      //console.log("Points map:", points_map)

      // Scale object points to map coordinates
      var object_points_map = math.matrix(object_points.projectPointsToMap())

      // Find nearest objects to each path x-y point
      nearest_z = math.matrix([])
      for (var i = 0; i < points_map.size()[0]; i++) {
        var min_distance = 1e10;
        path_point = math.subset(points_map, math.index(i, math.range(0, points_map.size()[1])))
        closest_point_elevation = 0.0
        for (var j = 0; j < object_points_map.size()[0]; j++) {
          object_point = math.subset(object_points_map, math.index(j, math.range(0, object_points_map.size()[1])))
          distance = math.sqrt((path_point._data[0][0] - object_point._data[0][0]) ** 2 + (path_point._data[0][1] - object_point._data[0][1]) ** 2);

          if (distance < min_distance) {
            min_distance = distance
            closest_point_elevation = object_elevations[j]
          }
        }
        nearest_z = math.concat(nearest_z, [closest_point_elevation], 0)
      }

      nearest_z = nearest_z.resize([nearest_z.size()[0], 1])
      //most_common_nearest_z = most_frequent(nearest_z._data)
      //nearest_z = math.multiply(math.ones(nearest_z.size()[0], 1), most_common_nearest_z)
      // // Append nearest object points
      points_map = math.concat(points_map, nearest_z, 1)

      // 2) Subtract egopose translation
      for (var i = 0; i < points_map.size()[0]; i++) {
        new_point = math.subtract(math.subset(points_map, math.index(i, math.range(0, points_map.size()[1]))), egopose_translation)
        points_map.subset(math.index(i, math.range(0, points_map.size()[1])), new_point)
      }

      points_map = math.transpose(points_map)

      // 3) Rotate by egopose rotation matrix
      points_map = math.multiply(math.transpose(egopose_rotmat), points_map)
      points_map = math.transpose(points_map)

      // 4) Subtract camera translation
      for (var i = 0; i < points_map.size()[0]; i++) {
        new_point = math.subtract(math.subset(points_map, math.index(i, math.range(0, points_map.size()[1]))), cam_translation)
        points_map.subset(math.index(i, math.range(0, points_map.size()[1])), new_point)
      }
      points_map = math.transpose(points_map)

      // 5) Rotate by camera rotation matrix
      points_map = math.multiply(math.transpose(cam_rotmat), points_map)
      points_map = math.transpose(points_map)
      // 6) Map to image view
      var viewpad = math.matrix(cam_intrinsics)
      viewpad = math.concat(viewpad, math.zeros(viewpad.size()[0], 1), 1)
      viewpad = math.concat(viewpad, math.zeros(1, viewpad.size()[1]), 0)
      viewpad.subset(math.index(3, 3), 1)
      points_frontal = math.transpose(points_map)
      points_frontal = math.concat(points_frontal, math.ones(1, points_frontal.size()[1]), 0)
      points_frontal = math.multiply(viewpad, points_frontal)
      points_frontal = math.subset(points_frontal, math.index(math.range(0, 3), math.range(0, points_frontal.size()[1])))
      norm = math.subset(points_frontal, math.index(2, math.range(0, points_frontal.size()[1])))
      norm = math.concat(norm, norm, norm, 0)
      points_frontal = math.dotDivide(points_frontal, norm)
      points_frontal = math.subset(points_frontal, math.index(math.range(0, 2), math.range(0, points_frontal.size()[1])))
      points_frontal = math.transpose(points_frontal)
      // Finally transform to the canvas
      points_frontal_x = math.multiply(math.subset(points_frontal, math.index(math.range(0, points_frontal.size()[0]), 0)), frontalViewRatioW);
      points_frontal_y = math.multiply(math.subset(points_frontal, math.index(math.range(0, points_frontal.size()[0]), 1)), frontalViewRatioH);

      points_frontal = math.concat(points_frontal_x, points_frontal_y, 1);

      return points_frontal;
    }

    function drawPathOnFrontalView() {
      if (path_points.items.length < 2) {
        context = canvasFrontal.getContext('2d');
        context.clearRect(0, 0, canvasFrontal.width, canvasFrontal.height);
      }
      var projectedPoints = projectElevatedPathToFrontalView();
      if (projectedPoints === undefined) return
      var context = canvasFrontal.getContext('2d');
      //context.lineWidth = 3;
      context.strokeStyle = "rgba(50,205,50,0.75)";
      context.clearRect(0, 0, canvasFrontal.width, canvasFrontal.height);


      for (var i = 0; i < projectedPoints.size()[0] - 1; i++) {
        context.beginPath();
        context.moveTo(
          math.subset(projectedPoints, math.index(i, 0)),
          math.subset(projectedPoints, math.index(i, 1))
        );
        context.lineTo(
          math.subset(projectedPoints, math.index(i + 1, 0)),
          math.subset(projectedPoints, math.index(i + 1, 1))
        );
        context.stroke();
      }
    }


    function projectPointsToMap() {
      var points_map = [];

      // points are (a,b)
      // we need to transform them to global view
      this.eachItem(point => {
        points_map.push([point.x, point.y]);
      });

      var points_map = math.matrix(points_map)
      var canvasTopDown_size = math.matrix([canvasTopDown.width, canvasTopDown.height]) // Width, Height

      var map_patch_corner_x = map_patch.subset(math.index(0))
      var map_patch_corner_y = map_patch.subset(math.index(1))
      var map_patch_width = map_patch.subset(math.index(2)) - map_patch.subset(math.index(0))
      var map_patch_height = map_patch.subset(math.index(3)) - map_patch.subset(math.index(1))

      var canvasTopDown_width = canvasTopDown_size.subset(math.index(0))
      var canvasTopDown_height = canvasTopDown_size.subset(math.index(1))

      var x = points_map.subset(math.index(math.range(0, points_map.size()[0]), 0))
      var y = points_map.subset(math.index(math.range(0, points_map.size()[0]), 1))

      var x_trans = math.add(math.divide(math.multiply(x, map_patch_width), canvasTopDown_width), map_patch_corner_x)
      var y_trans = math.add(math.divide(math.multiply(math.subtract(canvasTopDown_height, y), map_patch_height), canvasTopDown_height), map_patch_corner_y)

      if (points_map.size()[0] == 1) {
        x_trans = math.matrix([[x_trans]]);
        y_trans = math.matrix([[y_trans]]);
      }
      var points_map = math.concat(x_trans, y_trans, 1)
      return points_map
    }

    function projectPathToTopDownView(car_end_point_pos) {
      if (path_points.items.length < 2) {
        return;
      }
      var points_top_down = []
      path_points.eachItem(point => {
        points_top_down.push([point.x, point.y]);
      });

      if (car_end_point_pos) {
        points_top_down.push([car_end_point_pos.x, car_end_point_pos.y])
      }

      points_top_down = math.matrix(points_top_down);
      points_top_down = math.matrix(computePolygonSides(points_top_down._data, 5))

      return points_top_down;
    }

    function drawPathOnTopDownView() {
      if (path_points.items.length < 2) {
        return;
      }
      var projectedPoints = projectPathToTopDownView();
      var context = canvasTopDown.getContext('2d');
      context.strokeStyle = "rgba(50,205,50,0.75)";
      context.clearRect(0, 0, canvasTopDown.width, canvasTopDown.height);

      for (var i = 0; i < projectedPoints.size()[0] - 1; i++) {
        context.beginPath();
        context.moveTo(
          math.subset(projectedPoints, math.index(i, 0)),
          math.subset(projectedPoints, math.index(i, 1))
        );
        context.lineTo(
          math.subset(projectedPoints, math.index(i + 1, 0)),
          math.subset(projectedPoints, math.index(i + 1, 1))
        );
        context.stroke();
      }

    }

    function getMapToCanvas(map_point, map_patch) {
      var map_patch_corner_x = map_patch.subset(math.index(0))
      var map_patch_corner_y = map_patch.subset(math.index(1))
      var map_patch_width = map_patch.subset(math.index(2)) - map_patch.subset(math.index(0))
      var map_patch_height = map_patch.subset(math.index(3)) - map_patch.subset(math.index(1))

      var canvasTopDown_width = canvasTopDown.width;
      var canvasTopDown_height = canvasTopDown.height;

      canvas_point_x = math.multiply(math.divide(math.subtract(map_point[0], map_patch_corner_x), (map_patch_width)), canvasTopDown_width);
      canvas_point_y = math.multiply(math.subtract(1, math.divide(math.subtract(map_point[1], map_patch_corner_y), (map_patch_height))), canvasTopDown_height);
      return [canvas_point_x, canvas_point_y]
    }

    function getCanvasToMap(canvas_point, map_patch) {
      var map_patch_corner_x = map_patch.subset(math.index(0))
      var map_patch_corner_y = map_patch.subset(math.index(1))
      var map_patch_width = map_patch.subset(math.index(2)) - map_patch.subset(math.index(0))
      var map_patch_height = map_patch.subset(math.index(3)) - map_patch.subset(math.index(1))

      var canvasTopDown_width = canvasTopDown.width;
      var canvasTopDown_height = canvasTopDown.height;

      map_point_x = math.add(math.divide(math.multiply(canvas_point[0], map_patch_width), canvasTopDown_width), map_patch_corner_x)
      map_point_y = math.add(math.divide(math.multiply(math.subtract(canvasTopDown_height, canvas_point[1]), map_patch_height), canvasTopDown_height), map_patch_corner_y)
      return [map_point_x, map_point_y]
    }

    function getPointInFront(center_point, rot_matrix, distance) {
      // Facing angle in radians
      facing_angle = math.atan2(
        math.subset(rot_matrix, math.index(0, 0)),
        math.subset(rot_matrix, math.index(0, 1))
      )

      x_front = math.sin(facing_angle) * distance + center_point[0]
      y_front = -math.cos(facing_angle) * distance + center_point[1]

      front_point = [x_front, y_front]
      return front_point
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    function createList(extend) {
      return Object.assign({}, list, { items: [] }, extend);
    }

    function getClosest(from, minDist) {
      var closestPoint;
      this.eachItem(point => {
        const dist = Math.hypot(from.x - point.x, from.y - point.y);
        if (dist < minDist) {
          closestPoint = point;
          minDist = dist;
        }
      });
      return closestPoint;
    }

    function getClosestIx(from, minDist) {
      var closestPoint;
      var ix = 0;
      var closestIx = -1;
      this.eachItem(point => {
        const dist = Math.hypot(from.x - point.x, from.y - point.y);
        if (dist < minDist) {
          closestPoint = point;
          minDist = dist;
          closestIx = ix;
        }
        ix++;
      });
      return closestIx;
    }

    function distanceLineFromPoint(line, point) {
      const lx = path_points.items[line.p1].x;
      const ly = path_points.items[line.p1].y;
      const v1x = path_points.items[line.p2].x - lx;
      const v1y = path_points.items[line.p2].y - ly;
      const v2x = point.x - lx;
      const v2y = point.y - ly;
      // get unit dist of closest point
      const u = (v2x * v1x + v2y * v1y) / (v1y * v1y + v1x * v1x);
      if (u >= 0 && u <= 1) {  // is the point on the line
        return Math.hypot(lx + v1x * u - point.x, ly + v1y * u - point.y);
      } else if (u < 0) {  // point is before start
        return Math.hypot(lx - point.x, ly - point.y);
      }
      // point is after end of line
      return Math.hypot(path_points.items[line.p2].x - point.x, path_points.items[line.p2].y - point.y);
    }

    // this will extend the lines list
    function getClosestline(from, minDist) {
      var closestLine;
      this.eachItem(line => {
        const dist = distanceLineFromPoint(line, from);
        if (dist < minDist) {
          closestLine = line;
          minDist = dist;
        }
      });
      return closestLine;
    }
    function drawPoint(point) {
      topDownCtx.moveTo(point.x, point.y);
      topDownCtx.rect(point.x - 2, point.y - 2, 4, 4);
    }
    function drawLine(line) {
      topDownCtx.moveTo(path_points.items[line.p1].x, path_points.items[line.p1].y);
      topDownCtx.lineTo(path_points.items[line.p2].x, path_points.items[line.p2].y);
    }
    function drawLines() { this.eachItem(line => drawLine(line)) }
    function drawPoints() { this.eachItem(point => drawPoint(point)) }

    var object_elevations;
    var car_box_format_relative = null;

    var object_points;
    function createObjectPoints() {
      return createList({
        getClosest: getClosest,
        getClosestIx: getClosestIx,
        projectPointsToMap: projectPointsToMap,
      });
    }

    var path_points;
    function createPath() {
      return createList({
        draw: drawPoints,
        getClosest: getClosest,
        getClosestIx: getClosestIx,
        projectPointsToMap: projectPointsToMap,
        projectPathToTopDownView: projectPathToTopDownView,
        drawPathOnFrontalView: drawPathOnFrontalView,
        drawPathOnTopDownView: drawPathOnTopDownView
      });
    }

    var lines;
    function createLines() {
      return createList({
        getClosest: getClosestline,
        draw: drawLines,
      });
    }

    const mouse = { x: 0, y: 0, button: false, drag: false, dragStart: false, dragEnd: false, dragStartX: 0, dragStartY: 0 }
    function mouseEvents(e) {
      if (play) { return; }

      mouse.x = e.pageX - canvasTopDownOffsetX;
      mouse.y = e.pageY - canvasTopDownOffsetY;
      const lb = mouse.button;
      mouse.button = e.type === "mousedown" ? true : e.type === "mouseup" ? false : mouse.button;
      if (lb !== mouse.button) {
        if (mouse.button) {
          mouse.drag = true;
          mouse.dragStart = true;
          mouse.dragStartX = mouse.x;
          mouse.dragStartY = mouse.y;
        } else {
          mouse.drag = false;
          mouse.dragEnd = true;
        }
      }
    }

    $(document).keypress(function (event) {
      if (play) { return };
      var keycode = (event.keyCode ? event.keyCode : event.which);
      if (keycode = '115') {
        if (closestObjectIx > -1) {
          if (closestObjectIx == referredObjectIx) {
            referredObjectIx = -1;
          } else {
            referredObjectIx = closestObjectIx;
          }
        }
      }
    });

    //["down", "up", "move"].forEach(name => document.addEventListener("mouse" + name, mouseEvents));
    ["down", "up", "move"].forEach(name => document.getElementById('top-down-view').addEventListener("mouse" + name, mouseEvents));
    // short cut vars
    var canvasTopDownW;
    var canvasTopDownH;
    var canvasTopDownCw;
    var canvasTopDownCh;
    var globalTime;
    var closestLine;
    var closestPoint;
    var pointDrag; // true is dragging a point else dragging a line
    var dragOffsetX;
    var dragOffsetY;
    var cursor;
    var toolTip;
    var helpCount = 0;
    const minDist = 12;
    const minObjDist = 12;
    const lineStyle = {
      lineWidth: 2,
      strokeStyle: "green",
    }
    const pointStyle = {
      lineWidth: 1,
      strokeStyle: "blue",
    }
    const highlightStyle = {
      lineWidth: 3,
      strokeStyle: "red",
    }
    const font = {
      font: "18px arial",
      fillStyle: "black",
      textAlign: "center",
    }


    // main update function
    function update(timer) {

      checkTasks()
      enableSubmit()

      if (canvasTopDown === undefined) {
        console.log("not initiliased yet!!");
        requestAnimationFrame(update);
        return;
      }
      cursor = "crosshair";
      globalTime = timer;
      topDownCtx.setTransform(1, 0, 0, 1, 0, 0); // reset transform
      topDownCtx.globalAlpha = 1;           // reset alpha
      topDownCtx.clearRect(0, 0, canvasTopDownW, canvasTopDownH);
      var canvasFrontal = document.getElementById('frontal-view-canvas')
      var context = canvasFrontal.getContext('2d');
      context.clearRect(0, 0, canvasFrontal.width, canvasFrontal.height);

      // if (play) {
      //   var frontalctx = canvasFrontal.getContext("2d");
      //   frontalctx.clearRect(0, 0, canvasFrontal.width, canvasFrontal.height);
      // }


      // if (first_run && !play) {
      if (first_run) {
        object_centers = input[idx]["frame_data"]["map_objects_center"]
        object_elevations = input[idx]["frame_data"]["map_objects_elevation"]
        map_patch = math.matrix(input[idx]["frame_data"]["map_patch"])
        egopose = input[idx]["frame_data"]["ego_translation"]
        subsequent_egocenters = input[idx]["frame_data"]["subsequent_egocenters"]

        for (i = 0; i < object_centers.length; i++) {
          object_center = object_centers[i]
          object_center = getMapToCanvas(object_center, map_patch)
          object_points.add(Point2(object_center[0], object_center[1]))
        }

        car_anchor = getPointInFront(egopose, egopose_rotmat, 0)

        //Filter all points that are too near
        for (i = 0; i < subsequent_egocenters.length; i++) {
          path_point = subsequent_egocenters[i]
          anchor_dist = Math.sqrt(
            Math.pow((car_anchor[0] - path_point[0]), 2) +
            Math.pow((car_anchor[1] - path_point[1]), 2)
          );
          if (anchor_dist > 2.0) {
            path_point = getMapToCanvas(path_point, map_patch)
            path_points.add(Point2(path_point[0], path_point[1]))
          }
        }


        first_run = false
      } else {
        storeCurrent();
      }


      if (mouse.drag === false) {
        closestLine = undefined;
        closestPoint = path_points.getClosest(mouse, minDist);
        closestPointIx = path_points.getClosestIx(mouse, minDist);
        closestObject = object_points.getClosest(mouse, minObjDist);
        closestObjectIx = object_points.getClosestIx(mouse, minObjDist);
      }

      // Show point
      setStyle(font);
      showPointCanvas = Point2(mouse.x, mouse.y);
      showPointMap = getCanvasToMap([showPointCanvas.x, showPointCanvas.y], map_patch)

      // if (!play) {
      //   // lines.draw();
      //   if (points.length() > 1) {
      //     points.drawPathOnFrontalView();
      //   }
      //   // drawPathOnFrontalView()
      //   drawObjectsFrontal(closestObjectIx);
      //   drawCarOnEndPointFrontalView();
      // }

      // draw all points and lines
      if (path_points.length() > 1) {
        path_points.drawPathOnFrontalView();
        path_points.drawPathOnTopDownView();
      }

      drawObjectsFrontal(closestObjectIx);

      setStyle(lineStyle);
      topDownCtx.beginPath();
      topDownCtx.stroke();
      setStyle(pointStyle);
      topDownCtx.beginPath();
      path_points.draw();
      topDownCtx.stroke();

      // drawPathOnTopDownView()
      drawObjectsTopDown(closestObjectIx);

      // draw highlighted point or line
      setStyle(highlightStyle);
      topDownCtx.beginPath();
      if (closestPoint) { drawPoint(closestPoint) }
      topDownCtx.stroke();

      // if (play || $("#video-slider").val() < input[idx]["command_data"]['max_frame_ind']) {
      //   var frontalctx = canvasFrontal.getContext("2d");
      //   frontalctx.clearRect(0, 0, canvasFrontal.width, canvasFrontal.height);
      // }

      requestAnimationFrame(update);
    }

    $(document).ready(function () {
      main();
      requestAnimationFrame(update);
    })
    //////////////////// END OF CANVAS CODE

    // Update the index, and save the text in the text area and render new data.
    function set_idx(new_idx, firstCall) {
      if (new_idx < 0 || new_idx >= num_images) return;

      document.activeElement.blur();

      // back up current data.
      if (firstCall !== true) {
        storeCurrent();
      }

      // increment index.
      idx = new_idx;

      // Render new data.
      // Get new points
      first_run = true;
      canvasTopDown = undefined;
      path_points = createPath();
      referredObjectIx = -1

      // Uncheck boxes
      if (firstCall !== true) {
        document.getElementById("commandBox").value = "";
      }

      if (createdAnnotationsOutputList.length > idx) {
        referredObjectIx = createdAnnotationsOutputList[idx]["command"]["referredObjectIx"]
        document.getElementById("commandBox").value = createdAnnotationsOutputList[idx]["command"]["commandText"]
      }

      object_points = createObjectPoints();
      lines = createLines();
      render();

      // If the UI is enabled, enable or disable the buttons depending on
      // the index.
      if (enabled) {
        var prev_btn = $('#prev-btn');
        var next_btn = $('#next-btn');
        prev_btn.prop('disabled', true);
        next_btn.prop('disabled', true);
        if (idx > 0) {
          prev_btn.prop('disabled', false);
        }
        if (idx < num_images - 1) next_btn.prop('disabled', false);
      }

      // Refresh the counter.
      $('.counter-top').text(idx + 1);
      $('.counter-bottom').text(num_images);
    }

    function storeCurrent() {
      // Storing the current points
      var out = {
        "scene_token": input[idx]["frame_data"]["scene_token"],
        "sample_token": input[idx]["frame_data"]["sample_token"],
        "command": {
          "commandText": document.getElementById("commandBox").value,
          "referredObjectIx": referredObjectIx,
        },
      }
      if (createdAnnotationsOutputList.length > idx) {
        createdAnnotationsOutputList[idx] = out;
      } else {
        createdAnnotationsOutputList.push(out);
      }

    }

    function checkTasks() {

      written_command = false
      selected_object = false

      if (document.getElementById("commandBox").value) { written_command = true }
      if (referredObjectIx > -1) { selected_object = true }

      if (selected_object) {
        document.getElementById("task_object").style.backgroundColor = "#5ae406"
      } else {
        document.getElementById("task_object").style.backgroundColor = "#f93005"
      }
      if (written_command) {
        document.getElementById("task_command").style.backgroundColor = "#5ae406"
      } else {
        document.getElementById("task_command").style.backgroundColor = "#f93005"
      }

    }

    function enableSubmit() {
      // Enable the submit button only if all the frames are annotated
      $('#submit-btn').prop('disabled', false);
      if (createdAnnotationsOutputList.length < num_images) {
        $('#submit-btn').prop('disabled', true);
      } else {
        for (var i = 0; i < num_images; i++) {
          createdAnnotationsOutput = createdAnnotationsOutputList[i];
          written_command = false
          selected_object = false
          any_checked_actions = false
          any_checked_legality = false

          createdAnnotationsOutputCommand = createdAnnotationsOutput["command"];
          if (createdAnnotationsOutputCommand["commandText"]) { written_command = true }
          if (createdAnnotationsOutputCommand["referredObjectIx"] > -1) { selected_object = true }

          if ((written_command == false) || (selected_object == false)) {
            $('#submit-btn').prop('disabled', true);
          }

        }
      }
    }

    // Enable the UI.
    function enable_hit() {
      enabled = true;

      // Enable components
      $('#next-btn').click(function () {
        set_idx(idx + 1);
      });
      $('#prev-btn').click(function () {
        set_idx(idx - 1);
      });

      // Set up submit handler.
      easyturk.setupSubmit();
      $('#submit-btn').click(function () {
        storeCurrent();

        // otherwise we're good. HIT done!
        easyturk.setOutput(createdAnnotationsOutputList);
      });
    }
  </script>
</body>

</html>